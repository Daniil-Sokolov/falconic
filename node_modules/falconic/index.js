'use strict';

const fs = require('fs');
const path = require('path');
const cp = require('child_process');
const os = require('os');

const pid = process.pid;
const count = os.cpus().length;

console.log(`Master pid: ${pid}`);
console.log(`Starting ${count} forks`);

const STATIC_PATH = path.join(process.cwd(), './src/routes');
const watch = (fork, i)=> {
	let currentChild = cp.fork(fork, i);
  fs.watch(STATIC_PATH, (e, f)=> currentChild ? currentChild.kill() : 0)
  currentChild.on("close", () => currentChild = watch(fork, i))
}

for (let i = 0; i < 1;) {
  //watch(__dirname + '/worker.js', [++i]);
  cp.fork(__dirname + '/worker.js', [++i]);
}